# English Learning Companion - Study Chat Dataflow
#
# 英语学习伴侣 - 基于豆包/火山引擎 API
#
# 数据流:
# 1. 用户输入: 语音输入(ASR转文字) 或 直接文字输入
# 2. AI 语法/词汇检查: 检查语法正确性、用词正确性
# 3. 生成学习报告: 对单词、句型错误的讲解
# 4. 存储到数据库: 记录问题词汇和学习进度
# 5. AI 老师回复: 生成对话回复并播放语音

nodes:
  # ============ 用户输入层 ============

  # MoFA 动态节点 - 用户文字输入 (从 UI 获取)
  - id: mofa-text-input
    path: dynamic
    outputs:
      - text          # 用户输入的文字
      - control       # 控制信号 (start/stop/reset)

  # MoFA 动态节点 - 用户语音输入 (从麦克风获取)
  - id: mofa-audio-input
    path: dynamic
    outputs:
      - audio         # PCM 音频数据
      - control       # 录音控制信号

  # 豆包 ASR - 语音转文字
  - id: doubao-asr
    build: cargo build --manifest-path ../../../node-hub/dora-doubao-asr/Cargo.toml
    path: ../../../node-hub/dora-doubao-asr/target/release/dora-doubao-asr
    inputs:
      audio: mofa-audio-input/audio
    outputs:
      - text          # ASR 识别的文字
      - status
      - log
    env:
      DOUBAO_APP_ID: ${DOUBAO_APP_ID:-}
      DOUBAO_ACCESS_TOKEN: ${DOUBAO_ACCESS_TOKEN:-}
      LANGUAGE: en
      DATABASE_URL: sqlite://learning_companion.db
      LOG_LEVEL: DEBUG
      RUST_LOG: debug
      DEBUG_ASR_STREAM: "true"
      DEBUG_AUDIO_INPUT: "true"
      DEBUG_TIMING: "true"

  # 用户输入合并器 - 合并文字输入和语音转文字
  - id: user-input-merger
    build: cargo build --manifest-path ../../../node-hub/dora-session-context/Cargo.toml
    path: ../../../node-hub/dora-session-context/target/release/dora-session-context
    inputs:
      text_input: mofa-text-input/text      # 直接文字输入
      asr_text: doubao-asr/text             # ASR 转换的文字
      reset: session-controller/control
    outputs:
      - user_text     # 合并后的用户文字输入
      - status
    env:
      LOG_LEVEL: DEBUG
      RUST_LOG: debug
      DEBUG_INPUT_MERGE: "true"
      DEBUG_TIMING: "true"

  # ============ AI 语法/词汇检查层 ============

  # 语法检查器 - 使用豆包 API 检查语法和词汇（仅负责分析，不操作数据库）
  - id: grammar-checker
    build: cargo build --manifest-path ../../../node-hub/dora-conversation-analyzer/Cargo.toml
    path: ../../../node-hub/dora-conversation-analyzer/target/release/dora-conversation-analyzer
    inputs:
      user_text: user-input-merger/user_text
    outputs:
      - analysis      # 分析报告 (JSON: session_id, user_text, issues, pronunciation_issues)
      - status
      - log
    env:
      DOUBAO_API_KEY: ${DOUBAO_API_KEY:-}
      DOUBAO_MODEL: doubao-pro-32k
      LOG_LEVEL: DEBUG
      RUST_LOG: debug
      DEBUG_ANALYSIS: "true"
      DEBUG_API_CALLS: "true"
      DEBUG_TIMING: "true"

  # ============ 数据存储层 ============

  # 学习数据写入器 - 专门负责将分析结果写入数据库
  - id: learning-db-writer
    build: cargo build --manifest-path ../../../node-hub/dora-learning-db-writer/Cargo.toml
    path: ../../../node-hub/dora-learning-db-writer/target/release/dora-learning-db-writer
    inputs:
      analysis: grammar-checker/analysis
    outputs:
      - result        # 存储结果 (success, issues_stored, pronunciation_issues_stored)
      - status
      - log
    env:
      DATABASE_URL: sqlite://learning_companion.db
      LOG_LEVEL: DEBUG
      RUST_LOG: debug
      DEBUG_DB_OPS: "true"
      DEBUG_TIMING: "true"

  # 学习数据读取器 - 专门负责从数据库读取需要复习的词汇
  - id: learning-db-reader
    build: cargo build --manifest-path ../../../node-hub/dora-learning-db-reader/Cargo.toml
    path: ../../../node-hub/dora-learning-db-reader/target/release/dora-learning-db-reader
    inputs:
      trigger: session-controller/control
    outputs:
      - selected_words  # 选择的词汇列表 (JSON: words, word_details, session_id)
      - status
      - log
    env:
      DATABASE_URL: sqlite://learning_companion.db
      MIN_WORDS: 20
      MAX_WORDS: 30
      LOG_LEVEL: DEBUG
      RUST_LOG: debug
      DEBUG_DB_OPS: "true"
      DEBUG_TIMING: "true"

  # ============ AI 老师对话层 ============

  # AI 英语老师 - 生成对话回复
  - id: english-teacher
    build: cargo build --manifest-path ../../../node-hub/dora-maas-client/Cargo.toml
    path: ../../../node-hub/dora-maas-client/target/release/dora-maas-client
    inputs:
      text: user-input-merger/user_text
      analysis: grammar-checker/analysis
      control: session-controller/control
    outputs:
      - text          # AI 回复文本
      - status
      - log
    env:
      MAAS_CONFIG_PATH: english_teacher_config.toml
      DOUBAO_API_KEY: ${DOUBAO_API_KEY:-}
      LOG_LEVEL: DEBUG
      RUST_LOG: debug
      DEBUG_METRICS: "true"
      DEBUG_API_CALLS: "true"
      DEBUG_TIMING: "true"

  # 豆包 TTS - 文字转语音 (美式英语)
  - id: doubao-tts
    build: cargo build --manifest-path ../../../node-hub/dora-doubao-tts/Cargo.toml
    path: ../../../node-hub/dora-doubao-tts/target/release/dora-doubao-tts
    inputs:
      text: english-teacher/text
    outputs:
      - audio
      - status
      - log
    env:
      DOUBAO_APP_ID: ${DOUBAO_APP_ID:-}
      DOUBAO_ACCESS_TOKEN: ${DOUBAO_ACCESS_TOKEN:-}
      VOICE_TYPE: BV700_V2_streaming   # 美式英语女声
      SPEED_RATIO: 1.0
      LOG_LEVEL: DEBUG
      RUST_LOG: debug
      DEBUG_TTS_STREAM: "true"
      DEBUG_AUDIO_OUTPUT: "true"
      DEBUG_TIMING: "true"

  # ============ MoFA UI 显示层 ============

  # 音频播放器 - 播放 AI 回复语音
  - id: mofa-audio-player
    path: dynamic
    env:
      LOG_LEVEL: DEBUG
      DEBUG_AUDIO_BUFFER: "true"
      DEBUG_PLAYBACK: "true"
      DEBUG_TIMING: "true"
    inputs:
      audio:
        source: doubao-tts/audio
        queue_size: 1000
      control:
        source: session-controller/control
        queue_size: 10
    outputs:
      - buffer_status
      - status
      - audio_complete
      - log

  # 聊天显示 - 显示对话历史和分析报告
  - id: mofa-chat-display
    path: dynamic
    env:
      LOG_LEVEL: DEBUG
      DEBUG_UI_UPDATE: "true"
    inputs:
      user_text:
        source: user-input-merger/user_text
        queue_size: 1000
      ai_text:
        source: english-teacher/text
        queue_size: 1000
      analysis:
        source: grammar-checker/analysis
        queue_size: 100
      db_result:
        source: learning-db-writer/result
        queue_size: 100
      selected_words:
        source: learning-db-reader/selected_words
        queue_size: 100
    outputs:
      - status

  # 系统日志 - 聚合所有节点日志
  - id: mofa-system-log
    path: dynamic
    inputs:
      asr_log:
        source: doubao-asr/log
        queue_size: 1000
      asr_status: doubao-asr/status
      grammar_log:
        source: grammar-checker/log
        queue_size: 1000
      grammar_status: grammar-checker/status
      teacher_log:
        source: english-teacher/log
        queue_size: 1000
      teacher_status: english-teacher/status
      tts_log:
        source: doubao-tts/log
        queue_size: 1000
      tts_status: doubao-tts/status
      db_writer_log:
        source: learning-db-writer/log
        queue_size: 1000
      db_writer_status: learning-db-writer/status
      db_reader_log:
        source: learning-db-reader/log
        queue_size: 1000
      db_reader_status: learning-db-reader/status
      audio_player_log:
        source: mofa-audio-player/log
        queue_size: 1000
      audio_status: mofa-audio-player/status

  # ============ 会话控制器 ============

  # 会话控制器 - 控制学习流程
  - id: session-controller
    build: cargo build --manifest-path ../../../node-hub/dora-session-controller/Cargo.toml
    path: ../../../node-hub/dora-session-controller/target/release/dora-session-controller
    inputs:
      user_input: mofa-text-input/control
      audio_complete: mofa-audio-player/audio_complete
      analysis: grammar-checker/analysis
    outputs:
      - control       # 控制信号 (start/stop/reset/next)
      - status
      - log
    env:
      SESSION_MODE: learning
      LOG_LEVEL: DEBUG
      RUST_LOG: debug
      DEBUG_SESSION_STATE: "true"
      DEBUG_CONTROL_FLOW: "true"
      DEBUG_TIMING: "true"
