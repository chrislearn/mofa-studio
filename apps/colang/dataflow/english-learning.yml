# English Learning Companion - Voice Chat Dataflow
# Uses Doubao Volcanic Engine APIs for ASR, TTS, and conversation
# Implements spaced repetition learning with SQLite database

nodes:
  # ============ Word Selection & Topic Generation ============
  
  # Selects 20-30 words from database for review (max 5 times per day per word)
  - id: word-selector
    build: cargo build --manifest-path ../../../node-hub/dora-word-selector/Cargo.toml
    path: ../../../node-hub/dora-word-selector/target/release/dora-word-selector
    inputs:
      trigger: session-controller/start_trigger
      control: session-controller/control
    outputs:
      - selected_words
      - status
    env:
      DATABASE_URL: sqlite:///d:/Works/chrislearn/mofa-studio/apps/colang/learning_companion.db
      MIN_WORDS: 20
      MAX_WORDS: 30
      LOG_LEVEL: INFO

  # Generates conversation topic based on selected words using Doubao AI
  - id: topic-generator
    build: cargo build --manifest-path ../../../node-hub/dora-topic-generator/Cargo.toml
    path: ../../../node-hub/dora-topic-generator/target/release/dora-topic-generator
    inputs:
      selected_words: word-selector/selected_words
    outputs:
      - topic
      - status
    env:
      DOUBAO_API_KEY: ${DOUBAO_API_KEY:-}
      DOUBAO_MODEL: doubao-pro-32k
      LOG_LEVEL: INFO

  # ============ Session Context Management ============
  
  # Manages session context - ensures AI only responds to user input
  # Topic is stored but does NOT trigger AI response
  - id: session-context
    build: cargo build --manifest-path ../../../node-hub/dora-session-context/Cargo.toml
    path: ../../../node-hub/dora-session-context/target/release/dora-session-context
    inputs:
      topic: topic-generator/topic  # Receives topic but doesn't forward it
      user_text: doubao-asr/text    # Only forwards when user speaks
      reset: session-controller/control
    outputs:
      - chat_input  # Combined input sent to AI only when user speaks
      - status
    env:
      LOG_LEVEL: INFO

  # ============ Audio Processing (Doubao APIs) ============

  # Speech Recognition using Doubao ASR
  - id: doubao-asr
    build: cargo build --manifest-path ../../../node-hub/dora-doubao-asr/Cargo.toml
    path: ../../../node-hub/dora-doubao-asr/target/release/dora-doubao-asr
    inputs:
      audio: mofa-audio-input/audio
    outputs:
      - text
      - status
    env:
      DOUBAO_APP_ID: ${DOUBAO_APP_ID:-}
      DOUBAO_ACCESS_TOKEN: ${DOUBAO_ACCESS_TOKEN:-}
      LANGUAGE: en
      DATABASE_URL: sqlite:///d:/Works/chrislearn/mofa-studio/apps/colang/learning_companion.db
      LOG_LEVEL: INFO

  # Text-to-Speech using Doubao TTS (American English voice)
  - id: doubao-tts
    build: cargo build --manifest-path ../../../node-hub/dora-doubao-tts/Cargo.toml
    path: ../../../node-hub/dora-doubao-tts/target/release/dora-doubao-tts
    inputs:
      text: ai-chat/response
    outputs:
      - audio
      - status
    env:
      DOUBAO_APP_ID: ${DOUBAO_APP_ID:-}
      DOUBAO_ACCESS_TOKEN: ${DOUBAO_ACCESS_TOKEN:-}
      VOICE_TYPE: BV700_V2_streaming
      SPEED_RATIO: 1.0
      DATABASE_URL: sqlite:///d:/Works/chrislearn/mofa-studio/apps/colang/learning_companion.db
      LOG_LEVEL: INFO

  # ============ AI Conversation ============

  # Chat completion using Doubao (豆包) API
  # IMPORTANT: Only receives input from session-context which ensures
  # AI only responds when user actually speaks, not when topic arrives
  - id: ai-chat
    build: cargo build --manifest-path ../../../node-hub/dora-maas-client/Cargo.toml
    path: ../../../node-hub/dora-maas-client/target/release/dora-maas-client
    inputs:
      text: 
        source: session-context/chat_input  # Gated input - only when user speaks
        queue_size: 1000
      control: session-controller/chat_control
    outputs:
      - response
      - status
      - log
    env:
      MAAS_CONFIG_PATH: english_teacher_config.toml
      DOUBAO_API_KEY: ${DOUBAO_API_KEY:-}
      LOG_LEVEL: INFO

  # ============ Conversation Analysis ============

  # Analyzes user text for pronunciation, grammar, vocabulary issues
  - id: conversation-analyzer
    build: cargo build --manifest-path ../../../node-hub/dora-conversation-analyzer/Cargo.toml
    path: ../../../node-hub/dora-conversation-analyzer/target/release/dora-conversation-analyzer
    inputs:
      user_text: doubao-asr/text
    outputs:
      - analysis
      - status
    env:
      DOUBAO_API_KEY: ${DOUBAO_API_KEY:-}
      DOUBAO_MODEL: doubao-pro-32k
      DATABASE_URL: sqlite:///d:/Works/chrislearn/mofa-studio/apps/colang/learning_companion.db
      LOG_LEVEL: INFO

  # ============ MoFA Integration (UI) ============

  # Audio input from microphone (placeholder - integrate with MoFA)
  - id: mofa-audio-input
    custom: mofa-bridge
    outputs:
      - audio

  # Audio output to speakers (placeholder - integrate with MoFA)
  - id: mofa-audio-player
    custom: mofa-bridge
    inputs:
      audio: doubao-tts/audio
    outputs:
      - audio_complete
      - buffer_status

  # Chat history display (placeholder - integrate with MoFA)
  - id: mofa-chat-display
    custom: mofa-bridge
    inputs:
      user_text: doubao-asr/text
      ai_text: ai-chat/response
      analysis: conversation-analyzer/analysis

  # ============ Session Controller ============

  # Controls the learning session flow
  - id: session-controller
    custom: timer-controller
    inputs:
      analysis: conversation-analyzer/analysis
    outputs:
      - start_trigger
      - control
      - chat_control
    env:
      # Trigger new session every 30 minutes
      SESSION_INTERVAL_MINUTES: 30
